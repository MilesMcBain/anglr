<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Spatial data and topology • rangl</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>

<!-- mathjax -->
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
  </head>

  <body>
    <div class="container template-vignette">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">rangl</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <script src="spatial-normal-forms_files/htmlwidgets-0.8/htmlwidgets.js"></script>
<link href="spatial-normal-forms_files/rglwidgetClass-2/rgl.css" rel="stylesheet" />
<script src="spatial-normal-forms_files/rglwidgetClass-2/rglClass.src.js"></script>
<script src="spatial-normal-forms_files/CanvasMatrix4-2016/CanvasMatrix.src.js"></script>
<script src="spatial-normal-forms_files/rglWebGL-binding-0.96.0/rglWebGL.js"></script>

<div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Spatial data and topology</h1>
                        <h4 class="author">Michael Sumner</h4>
            
            <h4 class="date">2016-11-26</h4>
          </div>

    
    
<div class="contents">
<div id="spatial-normal-forms" class="section level1">
<h1>Spatial normal forms</h1>
<p>In this document I describe a “normal-form” that provides a very general way of extending the traditional GIS forms, and is a bridge between vector and raster rather than being a different form altogether. The purpose of this document is to advocate for this general form of data organization that can be used for new extended uses of GIS. I’m not arguing that this be used in place of other optimized forms, although it can be: I am interested in operations that simply cannot be performed already.</p>
<p>When we talk about vector data in geo-spatial, we have at least three levels of hierarchy to consider in the data structures.</p>
<ul>
<li>objects (or features) - these are the things we primarily interact with and store data against</li>
<li>coordinates - these are the specific vertices, the dimensionless points that place our data in a geometry</li>
<li>branches - these are the parts that different objects are made of, they describe the way the coordinates are linked together, the topology</li>
</ul>
<p>GIS tools typically only provides direct access to the objects, though the relations between branches and coordinates can sometimes be seen.</p>
<p>We generally cannot store information against the branches or the coordinates, beyond what they inherently are defined by. For coordinates this is the X and Y values, and/or the longitude and latitudes, but simple features does provide the ability to store a “third” coordinate “Z” and or a measure coordinate “M”. M is typically used for “linear referencing”, and not a more general multidimensional geometry (like time).</p>
<p>I’ll use the countries example from a GeoPackage file provided here. I use R because I can tell the complete story with it, in a concrete and reproducible way.</p>
<p>Read in a polygon vector layer in traditional GIS form, and plot it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#library(rworldmap)</span>
<span class="co">#data(countriesLow)</span>
<span class="co">#p &lt;- countriesLow</span>
<span class="kw">library</span>(rgdal)
p &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;small_world.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;rangl&quot;</span>), <span class="st">&quot;ne_110m_admin_0_countries&quot;</span>)</code></pre></div>
<pre><code>## OGR data source with driver: GPKG 
## Source: &quot;C:/Users/mdsumner/Documents/R/win-library/3.3/rangl/extdata/small_world.gpkg&quot;, layer: &quot;ne_110m_admin_0_countries&quot;
## with 177 features
## It has 1 fields</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(p, <span class="dt">col =</span> viridis::<span class="kw">viridis</span>(<span class="kw">nrow</span>(p)))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>This object <code>p</code> presents a “data frame” (i.e. a table) front-end that we can query and use at the objects level, much like in some GIS software we can easily select a single object or row in a table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spbabel)
(pnganz &lt;-<span class="st"> </span><span class="kw">subset</span>(p, name %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Australia&quot;</span>, <span class="st">&quot;Indonesia&quot;</span>, <span class="st">&quot;New Zealand&quot;</span>, <span class="st">&quot;Papua New Guinea&quot;</span>)))</code></pre></div>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 4 
## extent      : 95.29303, 178.5171, -46.64124, 5.479821  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
## variables   : 1
## # A tibble: 4 × 1
##               name
## *           &lt;fctr&gt;
## 1        Australia
## 2        Indonesia
## 3      New Zealand
## 4 Papua New Guinea</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pnganz$color &lt;-<span class="st"> </span>viridis::<span class="kw">viridis</span>(<span class="kw">nrow</span>(pnganz))
<span class="kw">plot</span>(pnganz, <span class="dt">col =</span> viridis::<span class="kw">viridis</span>(<span class="kw">nrow</span>(pnganz)))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Looking at the object’s underlying geometric structure shows nested lists of matrixes of x,y coordinates. There is one matrix per branch, analogous to the way that feature parts are nested in standard Geom binary forms like WKB. Each component branch stores extra information about whether it is a hole, the ring direction, a coordinate for label plotting and so on. We otherwise cannot store any more information on the component parts though.</p>
<pre class="{r]))"><code></code></pre>
<p>NOTE: the <code>Spatial</code> classes here are <strong>pre-simple features</strong>, so they are more analogous to the structures in a shapefile in that a polygon hole’s “island parent”&quot; may be ambiguous, but this is not so important to this story. R now has simple features in the <code>sfr</code> project here, which adds Z, M and the possibility of some of the exotic types as well. <a href="https://github.com/edzer/sfr" class="uri">https://github.com/edzer/sfr</a></p>
<p>These hierarchical structures can be serialized and stored in different ways, typically they are stored as binary geoms and stored directly in a table.</p>
<p>An interesting aspect here is that these structures don’t describe the topology of the objects in any special way, these are just <em>paths</em> of coordinates, and when they are plotted or used in analysis there’s a rule about how space is enclosed by a closed path. If we treat them as lines, the only difference is to not treat them as enclosed paths. Literally the only difference in the structure of this object from the polygons version is the name of the class, and the behaviour that methods invoked for this object will provide.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">as</span>(pnganz, <span class="st">&quot;SpatialLinesDataFrame&quot;</span>))
<span class="kw">plot</span>(<span class="kw">as</span>(pnganz, <span class="st">&quot;SpatialLinesDataFrame&quot;</span>), <span class="dt">col =</span> viridis::<span class="kw">viridis</span>(<span class="kw">nrow</span>(pnganz), <span class="dt">alpha =</span> <span class="fl">0.7</span>), <span class="dt">lwd =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(<span class="kw">as</span>(<span class="kw">geometry</span>(pnganz[<span class="dv">1</span>,]), <span class="st">&quot;SpatialLines&quot;</span>))</code></pre></div>
<pre><code>## Formal class &#39;SpatialLines&#39; [package &quot;sp&quot;] with 3 slots
##   ..@ lines      :List of 1
##   .. ..$ :Formal class &#39;Lines&#39; [package &quot;sp&quot;] with 2 slots
##   .. .. .. ..@ Lines:List of 2
##   .. .. .. .. ..$ :Formal class &#39;Line&#39; [package &quot;sp&quot;] with 1 slot
##   .. .. .. .. .. .. ..@ coords: num [1:17, 1:2] 145 146 147 148 148 ...
##   .. .. .. .. ..$ :Formal class &#39;Line&#39; [package &quot;sp&quot;] with 1 slot
##   .. .. .. .. .. .. ..@ coords: num [1:224, 1:2] 144 144 145 145 145 ...
##   .. .. .. ..@ ID   : chr &quot;9&quot;
##   ..@ bbox       : num [1:2, 1:2] 113.3 -43.6 153.6 -10.7
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. ..$ : chr [1:2] &quot;x&quot; &quot;y&quot;
##   .. .. ..$ : chr [1:2] &quot;min&quot; &quot;max&quot;
##   ..@ proj4string:Formal class &#39;CRS&#39; [package &quot;sp&quot;] with 1 slot
##   .. .. ..@ projargs: chr &quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<p>If we convert these data to “normal form”, we actually need at least three tables, one each for the objects, the branches, and the coordinates (vertices). The <code>map_table</code> function in the <code>spbabel</code> package creates these but also adds another link table between branches and vertices to enable de-duplication of shared vertices. The de-duplication is required for triangulating the polygons, and other topological operations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs &lt;-<span class="st"> </span>spbabel::<span class="kw">map_table</span>(pnganz)
<span class="kw">print</span>(<span class="kw">names</span>(ptabs))</code></pre></div>
<pre><code>## [1] &quot;o&quot;   &quot;b&quot;   &quot;bXv&quot; &quot;v&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">sapply</span>(ptabs, nrow))</code></pre></div>
<pre><code>##   o   b bXv   v 
##   4  21 638 614</code></pre>
<p>Now it’s a bit clearer how the underlying entities are put together. Each table here has a unique relational id, this allows us to subset and recombine these tables without having to convert indexes each time.</p>
<p>The objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs$o</code></pre></div>
<pre><code>## # A tibble: 4 × 3
##               name     color    object_
## *           &lt;fctr&gt;     &lt;chr&gt;      &lt;chr&gt;
## 1        Australia #440154FF b4SWHqe1Rl
## 2        Indonesia #31688EFF E1Q8xoaUoS
## 3      New Zealand #35B779FF DhNjRO8BWE
## 4 Papua New Guinea #FDE725FF 0pp1FFarhm</code></pre>
<p>The branches record which object they belong to.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs$b</code></pre></div>
<pre><code>## # A tibble: 21 × 3
##       object_    branch_ island_
##         &lt;chr&gt;      &lt;chr&gt;   &lt;lgl&gt;
## 1  b4SWHqe1Rl 5hve0rggNr    TRUE
## 2  b4SWHqe1Rl dbJtMrjfk6    TRUE
## 3  E1Q8xoaUoS ZFJRwjLNlD    TRUE
## 4  E1Q8xoaUoS 5LbZqm4lbw    TRUE
## 5  E1Q8xoaUoS NlaDNsYgZV    TRUE
## 6  E1Q8xoaUoS e3M0E1sMLq    TRUE
## 7  E1Q8xoaUoS A7yQUC182p    TRUE
## 8  E1Q8xoaUoS krsWFkrY0y    TRUE
## 9  E1Q8xoaUoS lyFa0urnpW    TRUE
## 10 E1Q8xoaUoS 2mbBhACCpc    TRUE
## # ... with 11 more rows</code></pre>
<p>The branches-link-vertex table records the relationship between vertices and branches (by default the de-duplication is done in X-Y but it could be done in other geometric spaces, e.g. in 1D time or 3D X-Y-Z or X-Y-Time).</p>
<p>This is the <em>instances of vertices</em> as opposed to the unique paired values of coordinates themselves.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs$bXv</code></pre></div>
<pre><code>## # A tibble: 638 × 3
##       branch_ order_    vertex_
##         &lt;chr&gt;  &lt;int&gt;      &lt;chr&gt;
## 1  5hve0rggNr      1 51aAaAgPLX
## 2  5hve0rggNr      2 E76mN52GvR
## 3  5hve0rggNr      3 gKev3yzAp8
## 4  5hve0rggNr      4 jPZjgHZLfB
## 5  5hve0rggNr      5 yN9R45XmmA
## 6  5hve0rggNr      6 HpRc6cZMX0
## 7  5hve0rggNr      7 fcyRyESYT8
## 8  5hve0rggNr      8 NGVUuIqtpP
## 9  5hve0rggNr      9 rZCmpnF1RO
## 10 5hve0rggNr     10 8YKhPBs75N
## # ... with 628 more rows</code></pre>
<p>And finally the vertices. In this example there are fewer unique x-y vertex than there are <strong>instance of the vertices</strong>, not a one-to-one match. This discrepancy obviously increases greatly for layers with shared boundaries, though in this example it is mostly due to the final closing coordinate on each polygon path - it’s a repeated instance, but not a repeated vertex <em>value</em>. There is at least one shared edge in this layer, clearly the one between Indonesia and Papua New Guinea.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs$v</code></pre></div>
<pre><code>## # A tibble: 614 × 3
##          x_        y_    vertex_
##       &lt;dbl&gt;     &lt;dbl&gt;      &lt;chr&gt;
## 1  145.3980 -40.79255 51aAaAgPLX
## 2  146.3641 -41.13770 E76mN52GvR
## 3  146.9086 -41.00055 gKev3yzAp8
## 4  147.6893 -40.80826 jPZjgHZLfB
## 5  148.2891 -40.87544 yN9R45XmmA
## 6  148.3599 -42.06245 HpRc6cZMX0
## 7  148.0173 -42.40702 fcyRyESYT8
## 8  147.9141 -43.21152 NGVUuIqtpP
## 9  147.5646 -42.93769 rZCmpnF1RO
## 10 146.8703 -43.63460 8YKhPBs75N
## # ... with 604 more rows</code></pre>
<div id="polygons-are-just-lines" class="section level2">
<h2>Polygons are just lines</h2>
<p>From this form we can see clearly that polygons and lines in GIS are really the same thing, we have <em>paths of coordinates</em> and then rules about how they are used.</p>
<p>If we compare each entity table side by side it’s clear the only difference is whether a branch is badged as an island vs. a hole.</p>
<p>For points we don’t need the branches or the order data, though for multipoints we do need branch.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ltabs &lt;-<span class="st"> </span>spbabel::<span class="kw">map_table</span>(<span class="kw">as</span>(pnganz, <span class="st">&quot;SpatialLinesDataFrame&quot;</span>))

for (i in <span class="kw">seq_along</span>(ltabs)) {
  <span class="kw">writeLines</span>(<span class="st">&quot;------------------------------&quot;</span>)
  <span class="kw">print</span>(ltabs[i])
  <span class="kw">print</span>(ptabs[i])
  <span class="kw">writeLines</span>(<span class="st">&quot;&quot;</span>)
  
}</code></pre></div>
<pre><code>## ------------------------------
## $o
## # A tibble: 4 × 3
##               name     color    object_
## *           &lt;fctr&gt;     &lt;chr&gt;      &lt;chr&gt;
## 1        Australia #440154FF 2ep6vHz8vo
## 2        Indonesia #31688EFF KVAN6Bbxx9
## 3      New Zealand #35B779FF BLX129fXAl
## 4 Papua New Guinea #FDE725FF 3jfxEZFpv4
## 
## $o
## # A tibble: 4 × 3
##               name     color    object_
## *           &lt;fctr&gt;     &lt;chr&gt;      &lt;chr&gt;
## 1        Australia #440154FF b4SWHqe1Rl
## 2        Indonesia #31688EFF E1Q8xoaUoS
## 3      New Zealand #35B779FF DhNjRO8BWE
## 4 Papua New Guinea #FDE725FF 0pp1FFarhm
## 
## 
## ------------------------------
## $b
## # A tibble: 21 × 2
##       object_    branch_
##         &lt;chr&gt;      &lt;chr&gt;
## 1  2ep6vHz8vo xwGFzKIcDN
## 2  2ep6vHz8vo PqmxQYlQ4m
## 3  KVAN6Bbxx9 0W6soLkmmv
## 4  KVAN6Bbxx9 9pv4zOYUk2
## 5  KVAN6Bbxx9 kAoI7YAGUJ
## 6  KVAN6Bbxx9 Fi0ivwPQur
## 7  KVAN6Bbxx9 bBUTRUocq9
## 8  KVAN6Bbxx9 7bjqQHoOWY
## 9  KVAN6Bbxx9 TzME98HhBd
## 10 KVAN6Bbxx9 hDAMc4H0vp
## # ... with 11 more rows
## 
## $b
## # A tibble: 21 × 3
##       object_    branch_ island_
##         &lt;chr&gt;      &lt;chr&gt;   &lt;lgl&gt;
## 1  b4SWHqe1Rl 5hve0rggNr    TRUE
## 2  b4SWHqe1Rl dbJtMrjfk6    TRUE
## 3  E1Q8xoaUoS ZFJRwjLNlD    TRUE
## 4  E1Q8xoaUoS 5LbZqm4lbw    TRUE
## 5  E1Q8xoaUoS NlaDNsYgZV    TRUE
## 6  E1Q8xoaUoS e3M0E1sMLq    TRUE
## 7  E1Q8xoaUoS A7yQUC182p    TRUE
## 8  E1Q8xoaUoS krsWFkrY0y    TRUE
## 9  E1Q8xoaUoS lyFa0urnpW    TRUE
## 10 E1Q8xoaUoS 2mbBhACCpc    TRUE
## # ... with 11 more rows
## 
## 
## ------------------------------
## $bXv
## # A tibble: 638 × 3
##       branch_ order_    vertex_
##         &lt;chr&gt;  &lt;int&gt;      &lt;chr&gt;
## 1  xwGFzKIcDN      1 zRZPWEaKHt
## 2  xwGFzKIcDN      2 TOIJc3QYCw
## 3  xwGFzKIcDN      3 GAOHxmcnf8
## 4  xwGFzKIcDN      4 LfVuLySAYl
## 5  xwGFzKIcDN      5 jmehg9aVez
## 6  xwGFzKIcDN      6 RPc0bOKIbw
## 7  xwGFzKIcDN      7 t69nak8yJu
## 8  xwGFzKIcDN      8 3mYELNROWD
## 9  xwGFzKIcDN      9 wWHvcZugsL
## 10 xwGFzKIcDN     10 4KkDD0vD6l
## # ... with 628 more rows
## 
## $bXv
## # A tibble: 638 × 3
##       branch_ order_    vertex_
##         &lt;chr&gt;  &lt;int&gt;      &lt;chr&gt;
## 1  5hve0rggNr      1 51aAaAgPLX
## 2  5hve0rggNr      2 E76mN52GvR
## 3  5hve0rggNr      3 gKev3yzAp8
## 4  5hve0rggNr      4 jPZjgHZLfB
## 5  5hve0rggNr      5 yN9R45XmmA
## 6  5hve0rggNr      6 HpRc6cZMX0
## 7  5hve0rggNr      7 fcyRyESYT8
## 8  5hve0rggNr      8 NGVUuIqtpP
## 9  5hve0rggNr      9 rZCmpnF1RO
## 10 5hve0rggNr     10 8YKhPBs75N
## # ... with 628 more rows
## 
## 
## ------------------------------
## $v
## # A tibble: 614 × 3
##          x_        y_    vertex_
##       &lt;dbl&gt;     &lt;dbl&gt;      &lt;chr&gt;
## 1  145.3980 -40.79255 zRZPWEaKHt
## 2  146.3641 -41.13770 TOIJc3QYCw
## 3  146.9086 -41.00055 GAOHxmcnf8
## 4  147.6893 -40.80826 LfVuLySAYl
## 5  148.2891 -40.87544 jmehg9aVez
## 6  148.3599 -42.06245 RPc0bOKIbw
## 7  148.0173 -42.40702 t69nak8yJu
## 8  147.9141 -43.21152 3mYELNROWD
## 9  147.5646 -42.93769 wWHvcZugsL
## 10 146.8703 -43.63460 4KkDD0vD6l
## # ... with 604 more rows
## 
## $v
## # A tibble: 614 × 3
##          x_        y_    vertex_
##       &lt;dbl&gt;     &lt;dbl&gt;      &lt;chr&gt;
## 1  145.3980 -40.79255 51aAaAgPLX
## 2  146.3641 -41.13770 E76mN52GvR
## 3  146.9086 -41.00055 gKev3yzAp8
## 4  147.6893 -40.80826 jPZjgHZLfB
## 5  148.2891 -40.87544 yN9R45XmmA
## 6  148.3599 -42.06245 HpRc6cZMX0
## 7  148.0173 -42.40702 fcyRyESYT8
## 8  147.9141 -43.21152 NGVUuIqtpP
## 9  147.5646 -42.93769 rZCmpnF1RO
## 10 146.8703 -43.63460 8YKhPBs75N
## # ... with 604 more rows</code></pre>
</div>
<div id="what-makes-polygons-different-to-lines" class="section level2">
<h2>What makes polygons different to lines?</h2>
<p>The coordinate-path structures used above for polygons and lines are very explicit, and in traditional form cannot be used in a more abstract way. By collecting the attributes of the entities in use into their own tables we start to build this abstraction. The paths are represented as a sequence of identifiers, rather than the actual coordinate values themselves. Why do this? We can abstract the choice of what do with those coordinate away from their storage. We also get a limited form of topology, in that a change made to one vertex coordinate attribute is reflected in all of the branches that use that vertex, analogous the Shared Edit mode in Manifold 8.0.</p>
<p>The next step in topological relationships is to represent each <em>segment</em> of a line rather than the entire path. To do this we need a table of segments, and a link table to store the identity of the two vertices used by those segments.</p>
<p>This has been implemented in the package <code>rangl</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lsegment &lt;-<span class="st"> </span>rangl::<span class="kw">rangl</span>(<span class="kw">as</span>(pnganz, <span class="st">&quot;SpatialLinesDataFrame&quot;</span>))
<span class="kw">as.data.frame</span>(<span class="kw">lapply</span>(lsegment, nrow))</code></pre></div>
<pre><code>##   o   v   l  lXv meta
## 1 4 614 617 1234    1</code></pre>
<p>This is no different for polygons when we store them as polygon paths, so then why is the segment/edge model useful? It provides a table to store metrics such as the length of the segment, its duration in time, and other information. The segment/edge model is also a required precursor for building a triangulated mesh. This brings us to an important stage of the story.</p>
</div>
<div id="polygons-are-not-composed-of-primitives" class="section level2">
<h2>Polygons are not composed of primitives</h2>
<p>Lines and polygons are stored as paths of coordinates, but lines can be decomposed to a more abstract form. Once in this form we can (in R) plot the lines much more quickly as segments, each with their own individual properties.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))
<span class="kw">plot</span>(lsegment$v$x_, lsegment$v$y_, <span class="dt">asp =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">axes =</span> <span class="ot">FALSE</span>)
<span class="kw">lines</span>(lsegment$v$x_, lsegment$v$y_, <span class="dt">col =</span> viridis::<span class="kw">viridis</span>(<span class="dv">4</span>))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>Not surprisingly, our connected line doesn’t make much sense, but worse our attempts at applying multiple colours was completely unsuccessful. Segments to the rescue.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))
<span class="kw">plot</span>(lsegment$v$x_, lsegment$v$y_, <span class="dt">asp =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">axes =</span> <span class="ot">FALSE</span>)
lsegment$o$color &lt;-<span class="st"> </span>viridis::<span class="kw">viridis</span>(<span class="kw">nrow</span>(lsegment$o))
<span class="co">#segs &lt;- lsegment$l %&gt;% inner_join(lsegment$o %&gt;% select(object_, color)) %&gt;% inner_join(lsegment$lXv) %&gt;% select(color, vertex_, segment_) %&gt;% inner_join(lsegment$v)</span>
segs &lt;-<span class="st"> </span>lsegment$lXv %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(lsegment$l) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(lsegment$o %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(object_, color)) %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(color, vertex_, segment_) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(lsegment$v)</code></pre></div>
<pre><code>## Joining, by = &quot;segment_&quot;</code></pre>
<pre><code>## Joining, by = &quot;object_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ix &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(segs)-<span class="dv">1</span>, <span class="dt">by  =</span> <span class="dv">2</span>);  <span class="kw">segments</span>(segs$x_[ix], segs$y_[ix], segs$x_[ix +<span class="st"> </span><span class="dv">1</span>], segs$y_[ix<span class="dv">+1</span>], <span class="dt">col =</span> segs$color[ix], <span class="dt">lwd =</span> <span class="dv">4</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>This is not lovely code, though it is straight forward and systematic. Treated as segments we automatically get the right “topology” of our lines, we joined the object attribute down to the actual pairs of coordinates and plotted all the segments individually. We managed to keep our object-part-coordinate hierarchy, though we’ve chosen primitives belonging to objects rather than branches as the model. This is also convenient for the next step because line segments are what we need for generating primitives to represent the polygons as surfaces.</p>
</div>
<div id="constrained-polygon-triangulation-starts-with-line-primitives" class="section level2">
<h2>Constrained polygon triangulation starts with line primitives</h2>
<p>Treat the polygon as segments build a triangulation, a surface of 2D triangle primitives.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prim2D &lt;-<span class="st"> </span>rangl::<span class="kw">rangl</span>(pnganz)
<span class="kw">plot</span>(pnganz, <span class="dt">border =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">lwd =</span> <span class="dv">4</span>)
for (i in <span class="kw">seq</span>(<span class="kw">nrow</span>(prim2D$t))) {
  tri &lt;-<span class="st"> </span>prim2D$t[i, ] %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(prim2D$tXv, <span class="st">&quot;triangle_&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(prim2D$v, <span class="st">&quot;vertex_&quot;</span>) %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(x_, y_)
  <span class="kw">polygon</span>(tri$x_, tri$y_, <span class="dt">border =</span> (prim2D$t[i, ] %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(prim2D$o, <span class="st">&quot;object_&quot;</span>))$color[<span class="dv">1</span>])
}</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>The plot loop above is very inefficient, but it’s purely to illustrate that we have the shapes in the right form. This is used in rangl to plot the shapes in 3D, either in native planar form or as a surface of a globe.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgl)
<span class="kw">plot</span>(prim2D, <span class="dt">specular =</span> <span class="st">&quot;black&quot;</span>)</code></pre></div>
<pre><code>## Joining, by = &quot;object_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subid &lt;-<span class="st"> </span><span class="kw">currentSubscene3d</span>()
<span class="kw">rglwidget</span>(<span class="dt">elementId=</span><span class="st">&quot;pnganz&quot;</span>)</code></pre></div>
<p>preservea6f7f4bf4b81fbda</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(rangl::<span class="kw">globe</span>(prim2D), <span class="dt">specular =</span> <span class="st">&quot;black&quot;</span>)</code></pre></div>
<pre><code>## Joining, by = &quot;object_&quot;
## Joining, by = &quot;triangle_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subid &lt;-<span class="st"> </span><span class="kw">currentSubscene3d</span>()
<span class="kw">rglwidget</span>(<span class="dt">elementId=</span><span class="st">&quot;png_anz_globe&quot;</span>)</code></pre></div>
<p>preserve0f844e5f9dd139a6</p>
<p>Why do this? It’s not just to plot a globe, but to see why it’s helpful to see what the function <code>globe()</code> does.</p>
<p>Run the layer through <code>globe()</code> and print out the vertices table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prim2D$v</code></pre></div>
<pre><code>## # A tibble: 614 × 3
##          x_        y_    vertex_
##       &lt;dbl&gt;     &lt;dbl&gt;      &lt;chr&gt;
## 1  114.6165 -28.51640 vqMOqUK3bE
## 2  114.6420 -28.81023 fAvJwz55Ml
## 3  115.0400 -29.46110 aoUoQDYybT
## 4  114.2329 -26.29845 7ataOXEWp3
## 5  113.7784 -26.54903 xGntvbT2KQ
## 6  114.0489 -27.33477 il4dU1zlD1
## 7  114.1736 -28.11808 mKPsjJO1Nf
## 8  113.4775 -26.54313 ztk03iPR1k
## 9  115.0268 -34.19652 TyEykZeTp9
## 10 115.5451 -33.48726 QPHZCcpIuL
## # ... with 604 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rangl::<span class="kw">globe</span>(prim2D)$v</code></pre></div>
<pre><code>## # A tibble: 614 × 4
##          x_      y_    vertex_       z_
##       &lt;dbl&gt;   &lt;dbl&gt;      &lt;chr&gt;    &lt;dbl&gt;
## 1  -2336231 5098892 vqMOqUK3bE -3026914
## 2  -2331985 5083655 fAvJwz55Ml -3055489
## 3  -2352381 5035508 aoUoQDYybT -3118501
## 4  -2348469 5217578 7ataOXEWp3 -2808743
## 5  -2302026 5224737 xGntvbT2KQ -2833605
## 6  -2310595 5177787 il4dU1zlD1 -2911217
## 7  -2305320 5135903 mKPsjJO1Nf -2988053
## 8  -2274676 5237020 ztk03iPR1k -2833021
## 9  -2234102 4785201 TyEykZeTp9 -3564497
## 10 -2296191 4804324 QPHZCcpIuL -3499156
## # ... with 604 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subid &lt;-<span class="st"> </span><span class="kw">currentSubscene3d</span>()
<span class="kw">rglwidget</span>(<span class="dt">elementId=</span><span class="st">&quot;prim2D&quot;</span>)</code></pre></div>
<p>preservef937a16d88541b19</p>
<p>The only thing that happened was that the input <code>x_</code> and <code>y_</code> were converted to geocentric “x, y, z” coordinates. Under the hood this is done by driving the transformation with PROJ.4 (via the R package <code>proj4</code>). The PROJ.4 family in use is “geocent”, i.e. here the <code>meta</code> table simply records the history of transformations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rangl::<span class="kw">globe</span>(prim2D)$meta[, <span class="kw">c</span>(<span class="st">&quot;proj&quot;</span>, <span class="st">&quot;ctime&quot;</span>)]</code></pre></div>
<pre><code>## # A tibble: 2 × 2
##                                                              proj
##                                                             &lt;chr&gt;
## 1                                      +proj=geocent +ellps=WGS84
## 2 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0
## # ... with 1 more variables: ctime &lt;chr&gt;</code></pre>
<p>We can otherwise do anything we like with the vertices, including reprojecting them and copying on other attributes.</p>
<p>As an example, copy on the Etopo5 elevations, first with the default triangulation, and then with a denser version.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## TBD</code></pre></div>
<p>Now for some examples to give an overview of diferent tools in R.</p>
</div>
<div id="base-graphics" class="section level2">
<h2>Base graphics</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p1 &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.75</span>, <span class="dv">1</span>,   <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.69</span>, <span class="dv">0</span>), 
           <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,    <span class="fl">0.8</span>, <span class="fl">0.7</span>, <span class="fl">0.6</span>, <span class="dv">0</span>,    <span class="dv">0</span>))
p2 &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.2</span>), 
            <span class="dt">y =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>))
p4 &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="fl">0.69</span>, <span class="fl">0.8</span>, <span class="fl">1.1</span>, <span class="fl">1.23</span>, <span class="fl">0.69</span>), 
            <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.6</span>, <span class="fl">0.63</span>, <span class="fl">0.3</span>, <span class="dv">0</span>))
pp &lt;-<span class="st"> </span><span class="kw">rbind</span>(p1, <span class="ot">NA</span>,  p2[<span class="kw">nrow</span>(p2):<span class="dv">1</span>, ])
<span class="kw">plot</span>(<span class="kw">rbind</span>(pp, p4), <span class="dt">cex =</span> <span class="fl">1.3</span>, <span class="dt">main =</span> <span class="st">&quot;two polygons, shared edge&quot;</span>)
<span class="kw">polypath</span>(pp, <span class="dt">col =</span> <span class="st">&quot;grey&quot;</span>)
<span class="kw">polypath</span>(p4, <span class="dt">col =</span> <span class="st">&quot;firebrick&quot;</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
</div>
<div id="simple-features-for-r" class="section level2">
<h2>Simple features for R</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#devtools::install_github(&quot;edzer/sfr&quot;)</span>
<span class="kw">library</span>(sf)</code></pre></div>
<pre><code>## Linking to GEOS 3.5.0, GDAL 2.1.1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tibble)
x &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">tibble</span>(<span class="dt">a =</span> <span class="dv">1</span>:<span class="dv">2</span>, <span class="dt">geom =</span> <span class="kw">st_sfc</span>(<span class="kw">list</span>(<span class="kw">st_multipolygon</span>(<span class="kw">list</span>(<span class="kw">list</span>(p1, p2[<span class="kw">rev</span>(<span class="kw">seq</span>(<span class="kw">nrow</span>(p2))), ]))),  
                                                 <span class="kw">st_multipolygon</span>(<span class="kw">list</span>(<span class="kw">list</span>(p4)))))))
<span class="kw">plot</span>(x, <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;grey&quot;</span>, <span class="st">&quot;firebrick&quot;</span>))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
</div>
<div id="spatial-legacy-sp-package" class="section level2">
<h2>Spatial (legacy sp package)</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sp)
spgdf &lt;-<span class="st"> </span><span class="kw">as</span>(x, <span class="st">&quot;Spatial&quot;</span>)
<span class="kw">plot</span>(spgdf, <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;grey&quot;</span>, <span class="st">&quot;firebrick&quot;</span>))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
</div>
<div id="grammar-of-graphics" class="section level2">
<h2>Grammar of graphics</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## fortify model
<span class="kw">library</span>(dplyr)
meta &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(x %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(-geom) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">object_ =</span> <span class="kw">row_number</span>()))
map &lt;-<span class="st"> </span>spbabel::<span class="kw">sptable</span>(spgdf)
<span class="kw">library</span>(ggplot2)
ggcols &lt;-<span class="st"> </span>ggplot2::<span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;1&quot;</span> =<span class="st"> &quot;grey&quot;</span>, <span class="st">&quot;2&quot;</span>  =<span class="st"> &quot;firebrick&quot;</span>)) 
<span class="kw">ggplot</span>(map %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">rn =</span> <span class="kw">row_number</span>()) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(meta)) +<span class="st"> </span><span class="kw">aes</span>(<span class="dt">x =</span> x_, <span class="dt">y =</span> y_, <span class="dt">group =</span> branch_, <span class="dt">fill =</span> <span class="kw">factor</span>(object_)) +
<span class="st">  </span>ggcols +<span class="st"> </span>ggpolypath::<span class="kw">geom_polypath</span>() +<span class="st"> </span><span class="kw">geom_path</span>()</code></pre></div>
<pre><code>## Joining, by = &quot;object_&quot;</code></pre>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
</div>
<div id="map-table" class="section level2">
<h2>Map table</h2>
<p>This is a four-table decomposition of Spatial objects, a normalization of the fortify model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spbabel)
mp &lt;-<span class="st"> </span><span class="kw">map_table</span>(spgdf)
ggcols &lt;-<span class="st"> </span>ggplot2::<span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">setNames</span>(<span class="kw">c</span>(<span class="st">&quot;grey&quot;</span>, <span class="st">&quot;firebrick&quot;</span>), mp$o$object_))
gg &lt;-<span class="st"> </span><span class="kw">ggplot</span>(mp$o %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(mp$b) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(mp$bXv) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(mp$v))</code></pre></div>
<pre><code>## Joining, by = &quot;object_&quot;</code></pre>
<pre><code>## Joining, by = &quot;branch_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gg +<span class="st"> </span><span class="kw">aes</span>(<span class="dt">x =</span> x_, <span class="dt">y =</span> y_, <span class="dt">group =</span> branch_, <span class="dt">fill =</span> object_) +<span class="st"> </span>ggcols +<span class="st"> </span>ggpolypath::<span class="kw">geom_polypath</span>() +<span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">lwd =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
</div>
<div id="planar-straight-line-graph" class="section level2">
<h2>Planar straight line graph</h2>
<p>Here we identify all <strong>edges</strong>, i.e. line segments between a pair of coordinates, regardless of direction.</p>
<p>Note in the second plot we identify “nodes”, and that there are two segments that overlap between the neighbouring polygons. In Arc speak this is just one arc, but in simple features it is just a segment on one polygon path, and another segment on the other polygon path, without any explicit record or knowledge of that relationship.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p2seg &lt;-<span class="st"> </span>function(x) <span class="kw">as_tibble</span>(rangl:::<span class="kw">path2seg</span>(x$vertex_))
BxE &lt;-<span class="st"> </span>mp$bXv %&gt;%<span class="st"> </span><span class="kw">split</span>(.$branch_) %&gt;%<span class="st"> </span>purrr::<span class="kw">map</span>(p2seg) %&gt;%<span class="st"> </span><span class="kw">bind_rows</span>(<span class="dt">.id =</span> <span class="st">&quot;branch_&quot;</span>) 
<span class="kw">ggplot</span>(BxE %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(mp$v %&gt;%<span class="st"> </span><span class="kw">rename</span>(<span class="dt">x =</span> x_, <span class="dt">y =</span> y_), <span class="kw">c</span>(<span class="st">&quot;V1&quot;</span> =<span class="st"> &quot;vertex_&quot;</span>)) %&gt;%<span class="st"> </span>
<span class="st">                            </span><span class="kw">inner_join</span>(mp$v, <span class="kw">c</span>(<span class="st">&quot;V2&quot;</span> =<span class="st"> &quot;vertex_&quot;</span>))) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">xend =</span> x_, <span class="dt">yend =</span> y_, <span class="dt">colour =</span> V1)) <span class="co">#+ guides(colour = FALSE)</span></code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">uE &lt;-<span class="st"> </span>mp$bXv %&gt;%<span class="st"> </span><span class="kw">split</span>(.$branch_) %&gt;%<span class="st"> </span>purrr::<span class="kw">map</span>(p2seg) %&gt;%<span class="st"> </span><span class="kw">bind_rows</span>(<span class="dt">.id =</span> <span class="st">&quot;branch_&quot;</span>)%&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">edge_ =</span> <span class="kw">row_number</span>()) %&gt;%<span class="st"> </span>
<span class="st">   </span><span class="kw">mutate</span>(<span class="dt">uu =</span> <span class="kw">paste</span>(<span class="kw">pmin</span>(V1, V2), <span class="kw">pmax</span>(V1, V2), <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)) %&gt;%<span class="st"> </span><span class="kw">distinct</span>(uu, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)
nodes &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(mp$v %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(uE, <span class="kw">c</span>(<span class="st">&quot;vertex_&quot;</span> =<span class="st"> &quot;V1&quot;</span>)), 
          mp$v %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(uE, <span class="kw">c</span>(<span class="st">&quot;vertex_&quot;</span> =<span class="st"> &quot;V2&quot;</span>))) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(edge_, vertex_) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">nb =</span> <span class="kw">n</span>()) %&gt;%<span class="st"> </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(nb &gt;<span class="st"> </span><span class="dv">2</span>) %&gt;%<span class="st"> </span><span class="kw">distinct</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(mp$v)</code></pre></div>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(spgdf)
<span class="kw">points</span>(nodes$x_, nodes$y_, <span class="dt">cex =</span> <span class="fl">0.9</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-24-2.png" width="672" /></p>
</div>
<div id="arc-node" class="section level2">
<h2>Arc-node</h2>
<p>What is arc-node? The nodes in the graph are the vertices that are shared by any two arcs. The arcs are the <em>paths</em> that trace a line between nodes. This means that not all coordinates are nodes, and even that not all <em>parts</em> have any node/s at all. We can produce this by traversal of all edges to determine the arcs that join nodes and anything left is just a standalone arc. This is brute-force remove duplicate edges (ignore direction), join on start vertex, end vertex, count the number of edges involved and any with 3 edges is a <strong>Node</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## what are the nodes?
x1 &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">&quot;shape/nc.shp&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>), <span class="st">&quot;nc&quot;</span>, <span class="dt">crs =</span> <span class="dv">4267</span>)</code></pre></div>
<pre><code>## Reading layer `nc&#39; from data source `E:\inst\R\R\library\sf\shape\nc.shp&#39; using driver `ESRI Shapefile&#39;
## converted into: MULTIPOLYGON
## Simple feature collection with 100 features and 14 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
## epsg (SRID):    4267
## proj4string:    +proj=longlat +datum=NAD27 +no_defs</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mp &lt;-<span class="st"> </span>spbabel::<span class="kw">map_table</span>(x1)
uE &lt;-<span class="st"> </span>mp$bXv %&gt;%<span class="st"> </span><span class="kw">split</span>(.$branch_) %&gt;%<span class="st"> </span>purrr::<span class="kw">map</span>(p2seg) %&gt;%<span class="st"> </span><span class="kw">bind_rows</span>(<span class="dt">.id =</span> <span class="st">&quot;branch_&quot;</span>)%&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">edge_ =</span> <span class="kw">row_number</span>()) %&gt;%<span class="st"> </span>
<span class="st">   </span><span class="kw">mutate</span>(<span class="dt">uu =</span> <span class="kw">paste</span>(<span class="kw">pmin</span>(V1, V2), <span class="kw">pmax</span>(V1, V2), <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)) %&gt;%<span class="st"> </span><span class="kw">distinct</span>(uu, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)
nodes &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(mp$v %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(uE, <span class="kw">c</span>(<span class="st">&quot;vertex_&quot;</span> =<span class="st"> &quot;V1&quot;</span>)), 
          mp$v %&gt;%<span class="st"> </span>dplyr::<span class="kw">select</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(uE, <span class="kw">c</span>(<span class="st">&quot;vertex_&quot;</span> =<span class="st"> &quot;V2&quot;</span>))) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(edge_, vertex_) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">nb =</span> <span class="kw">n</span>()) %&gt;%<span class="st"> </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(nb &gt;<span class="st"> </span><span class="dv">2</span>) %&gt;%<span class="st"> </span><span class="kw">distinct</span>(vertex_) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(mp$v)</code></pre></div>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(x1)
<span class="kw">points</span>(nodes$x_, nodes$y_, <span class="dt">cex =</span> <span class="fl">0.9</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>Arc-node topology was used by the Arc Info software prior to the invention of the shapefile and ArcView . . .</p>
<p>TopoJSON uses this model, or at least something very similar to it: <a href="https://github.com/topojson/topojson/wiki" class="uri">https://github.com/topojson/topojson/wiki</a></p>
</div>
<div id="simplicial-complex" class="section level2">
<h2>Simplicial complex</h2>
<p>The simplicial complex is more abstract than arc-node topology, but also much more general. Arcs can only be joined to bound regions in the plane, but the simplicial complex is composed of <strong>primitives</strong> for any topology. Coordinates are 0-D primitives, line segments are 1-D primitives, and triangles are 2-primitives. We are free to store any chosen geometry on the coordinates of primitives, so they can describe overlapping surfaces in 3D space, or connected paths through 4D space. There’s a natual extension up in dimension to volumes as well, where 3-D primitives (tetrahedron) compose 3D-space filling shapes, and so on.</p>
<p>In short, arc-node is one of several <em>2D-only</em> optimizations for spatial data that do no apply to higher dimensional topologies and/or higher dimensional geometry. The simplicial complex is a finite-element model that is general enough for any spatial or other hierarchically organized multi-dimensional data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sc &lt;-<span class="st"> </span>rangl::<span class="kw">rangl</span>(spgdf)

<span class="kw">plot</span>(sc)</code></pre></div>
<pre><code>## Joining, by = &quot;object_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(x)
l1 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(sc$o[<span class="dv">1</span>, ], sc$t) %&gt;%<span class="st"> </span><span class="kw">split</span>(.$triangle_) %&gt;%<span class="st"> </span>purrr::<span class="kw">map</span>(function(x) <span class="kw">inner_join</span>(x, sc$tXv) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(sc$v)) </code></pre></div>
<pre><code>## Joining, by = &quot;object_&quot;
## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">j &lt;-<span class="st"> </span><span class="kw">lapply</span>(l1, function(x) <span class="kw">polygon</span>(<span class="kw">cbind</span>(x$x_, x$y_), <span class="dt">col =</span> <span class="st">&quot;grey&quot;</span>))
l2 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(sc$o[<span class="dv">2</span>, ], sc$t) %&gt;%<span class="st"> </span><span class="kw">split</span>(.$triangle_) %&gt;%<span class="st"> </span>purrr::<span class="kw">map</span>(function(x) <span class="kw">inner_join</span>(x, sc$tXv) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(sc$v)) </code></pre></div>
<pre><code>## Joining, by = &quot;object_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<pre><code>## Joining, by = &quot;triangle_&quot;</code></pre>
<pre><code>## Joining, by = &quot;vertex_&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">j &lt;-<span class="st"> </span><span class="kw">lapply</span>(l2, function(x) <span class="kw">polygon</span>(<span class="kw">cbind</span>(x$x_, x$y_), <span class="dt">col =</span> <span class="st">&quot;firebrick&quot;</span>))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## this is slow but does show that we have a full and constrained triangulation
 <span class="kw">set.seed</span>(<span class="dv">75</span>)
sc &lt;-<span class="st"> </span>rangl::<span class="kw">rangl</span>(<span class="kw">as</span>(x1[<span class="dv">24</span>:<span class="dv">30</span>, ], <span class="st">&quot;Spatial&quot;</span>))
<span class="kw">plot</span>(x1[<span class="dv">24</span>:<span class="dv">30</span>, ], <span class="dt">border =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">lwd =</span> <span class="dv">4</span>)
for (i in <span class="kw">seq</span>(<span class="kw">nrow</span>(x1))) {
  l1 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(sc$o[i, ], sc$t, <span class="st">&quot;object_&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">split</span>(.$triangle_) %&gt;%<span class="st"> </span>purrr::<span class="kw">map</span>(function(x) <span class="kw">inner_join</span>(x, sc$tXv, <span class="st">&quot;triangle_&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">inner_join</span>(sc$v, <span class="st">&quot;vertex_&quot;</span>)) 
 
  j &lt;-<span class="st"> </span><span class="kw">lapply</span>(l1, function(x) <span class="kw">polygon</span>(<span class="kw">cbind</span>(x$x_, x$y_), <span class="dt">border =</span> <span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">&quot;grey&quot;</span>, <span class="st">&quot;firebrick&quot;</span>, viridis::<span class="kw">viridis</span>(<span class="dv">5</span>)), <span class="dv">1</span>)))
}</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-26-2.png" width="672" /></p>
</div>
<div id="affine-georeferenced-rasters" class="section level2">
<h2>Affine-georeferenced rasters</h2>
<p>These are very well supported by the raster package. Generally, affine refers to a linear transformation (which preserves points, straight lines and planes)[<a href="https://en.wikipedia.org/wiki/Affine_transformation" class="uri">https://en.wikipedia.org/wiki/Affine_transformation</a>]. In geo-spatial, the affine transform is the 6 numbers that define the offset (absolute position of one corner), the scale (pixel height and width), and skew (dual component scale). Usually skew (or “rotation”) is not used, though it is supported by GDAL, QGIS, <code>rasterImage</code> and <code>raster</code> (to some degree).</p>
<p>In <code>raster</code> the affine transform is the <code>extent()</code> which has a straightforward relation to the shift and scale values of the transform, with skew set to 0 for both X and Y.</p>
</div>
<div id="rectilinear-rasters" class="section level2">
<h2>Rectilinear rasters</h2>
<p>Not supported by <code>raster</code> or <code>rasterImage</code>, supported by <code>image</code>. This is when the positions of each pixel are non-linear, and independent in X and Y.</p>
</div>
<div id="curvilinear-rasters" class="section level2">
<h2>Curvilinear rasters</h2>
<p>These are not generally supported, though you can find them in NetCDF and HDF files. This is where you need an explicit coordinate for every pixel, so <em>topologicall</em> there is a raster in the sense that it’s a full grid of X<em>Y or X</em>Y*Z (or more) cells with an index relation.</p>
</div>
<div id="discrete-versus-continuous-rasters" class="section level2">
<h2>Discrete versus continuous rasters</h2>
<p>The distinction is supported by <code>image</code> but this is not generally covered in R, though it appears in topics of the exact details of extract for polygons on rasters. R’s base and grid graphics don’t have any support for textures, though rgl does.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul>
      <li><a href="#spatial-normal-forms">Spatial normal forms</a><ul>
      <li><a href="#polygons-are-just-lines">Polygons are just lines</a></li>
      <li><a href="#what-makes-polygons-different-to-lines">What makes polygons different to lines?</a></li>
      <li><a href="#polygons-are-not-composed-of-primitives">Polygons are not composed of primitives</a></li>
      <li><a href="#constrained-polygon-triangulation-starts-with-line-primitives">Constrained polygon triangulation starts with line primitives</a></li>
      <li><a href="#base-graphics">Base graphics</a></li>
      <li><a href="#simple-features-for-r">Simple features for R</a></li>
      <li><a href="#spatial-legacy-sp-package">Spatial (legacy sp package)</a></li>
      <li><a href="#grammar-of-graphics">Grammar of graphics</a></li>
      <li><a href="#map-table">Map table</a></li>
      <li><a href="#planar-straight-line-graph">Planar straight line graph</a></li>
      <li><a href="#arc-node">Arc-node</a></li>
      <li><a href="#simplicial-complex">Simplicial complex</a></li>
      <li><a href="#affine-georeferenced-rasters">Affine-georeferenced rasters</a></li>
      <li><a href="#rectilinear-rasters">Rectilinear rasters</a></li>
      <li><a href="#curvilinear-rasters">Curvilinear rasters</a></li>
      <li><a href="#discrete-versus-continuous-rasters">Discrete versus continuous rasters</a></li>
      </ul></li>
      </ul>
    </div>
      </div>

</div>


      <footer>
      <div class="copyright">
  <p>Developed by Michael D. Sumner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
