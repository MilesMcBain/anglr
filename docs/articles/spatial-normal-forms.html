<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial data and topology • anglr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">anglr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rangl-examples.html">Examples with anglr</a>
    </li>
    <li>
      <a href="../articles/rgl-guide.html">Vignette Title</a>
    </li>
    <li>
      <a href="../articles/spatial-normal-forms.html">Spatial data and topology</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><script src="spatial-normal-forms_files/htmlwidgets-0.9/htmlwidgets.js"></script><link href="spatial-normal-forms_files/rglwidgetClass-2/rgl.css" rel="stylesheet">
<script src="spatial-normal-forms_files/rglwidgetClass-2/rglClass.src.js"></script><script src="spatial-normal-forms_files/CanvasMatrix4-2016/CanvasMatrix.src.js"></script><script src="spatial-normal-forms_files/rglWebGL-binding-0.98.1/rglWebGL.js"></script><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Spatial data and topology</h1>
                        <h4 class="author">Michael Sumner</h4>
            
            <h4 class="date">2017-09-13</h4>
          </div>

    
    
<div class="contents">
<div id="spatial-normal-forms" class="section level1">
<h1 class="hasAnchor">
<a href="#spatial-normal-forms" class="anchor"></a>Spatial normal forms</h1>
<p>In this document I describe a “normal-form” that provides a very general way of extending the traditional GIS forms, and is a bridge between vector and raster rather than being a different form altogether. The purpose of this document is to advocate for this general form of data organization that can be used for new extended uses of GIS. I’m not arguing that this be used in place of other optimized forms, although it can be: I am interested in operations that simply cannot be performed already.</p>
<p>When we talk about vector data in geo-spatial, we have at least three levels of hierarchy to consider in the data structures.</p>
<ul>
<li>objects (or features) - these are the things we primarily interact with and store data against</li>
<li>coordinates - these are the specific vertices, the dimensionless points that place our data in a geometry</li>
<li>branches - these are the parts that different objects are made of, they describe the way the coordinates are linked together, the topology</li>
</ul>
<p>GIS tools typically only provides direct access to the objects, though the relations between branches and coordinates can sometimes be seen.</p>
<p>We generally cannot store information against the branches or the coordinates, beyond what they inherently are defined by. For coordinates this is the X and Y values, and/or the longitude and latitudes, but simple features does provide the ability to store a “third” coordinate “Z” and or a measure coordinate “M”. M is typically used for “linear referencing”, and not a more general multidimensional geometry (like time).</p>
<p>I’ll use the countries example from a GeoPackage file provided here. I use R because I can tell the complete story with it, in a concrete and reproducible way.</p>
<p>Read in a polygon vector layer in traditional GIS form, and plot it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#library(rworldmap)</span>
<span class="co">#data(countriesLow)</span>
<span class="co">#p &lt;- countriesLow</span>
<span class="kw">library</span>(rgdal)
p &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rgdal/topics/readOGR">readOGR</a></span>(<span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"small_world.gpkg"</span>, <span class="dt">package =</span> <span class="st">"anglr"</span>), <span class="st">"ne_110m_admin_0_countries"</span>)</code></pre></div>
<pre><code>## OGR data source with driver: GPKG 
## Source: "/perm_storage/home/mdsumner/R/x86_64-pc-linux-gnu-library/3.4/anglr/extdata/small_world.gpkg", layer: "ne_110m_admin_0_countries"
## with 177 features
## It has 1 fields</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(p, <span class="dt">col =</span> viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">viridis</a></span>(<span class="kw">nrow</span>(p)))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-1-1.png" width="672"></p>
<p>This object <code>p</code> presents a “data frame” (i.e. a table) front-end that we can query and use at the objects level, much like in some GIS software we can easily select a single object or row in a table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spbabel)
(pnganz &lt;-<span class="st"> </span><span class="kw">subset</span>(p, name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"Australia"</span>, <span class="st">"Indonesia"</span>, <span class="st">"New Zealand"</span>, <span class="st">"Papua New Guinea"</span>)))</code></pre></div>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 4 
## extent      : 95.29303, 178.5171, -46.64124, 5.479821  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
## variables   : 1
## # A tibble: 4 x 1
##               name
## *           &lt;fctr&gt;
## 1        Australia
## 2        Indonesia
## 3      New Zealand
## 4 Papua New Guinea</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pnganz<span class="op">$</span>color &lt;-<span class="st"> </span>viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">viridis</a></span>(<span class="kw">nrow</span>(pnganz))
<span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(pnganz, <span class="dt">col =</span> viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">viridis</a></span>(<span class="kw">nrow</span>(pnganz)))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Looking at the object’s underlying geometric structure shows nested lists of matrixes of x,y coordinates. There is one matrix per branch, analogous to the way that feature parts are nested in standard Geom binary forms like WKB. Each component branch stores extra information about whether it is a hole, the ring direction, a coordinate for label plotting and so on. We otherwise cannot store any more information on the component parts though.</p>
<pre class="{r]))"><code></code></pre>
<p>NOTE: the <code>Spatial</code> classes here are <strong>pre-simple features</strong>, so they are more analogous to the structures in a shapefile in that a polygon hole’s “island parent”" may be ambiguous, but this is not so important to this story. R now has simple features in the <code>sfr</code> project here, which adds Z, M and the possibility of some of the exotic types as well. <a href="https://github.com/edzer/sfr" class="uri">https://github.com/edzer/sfr</a></p>
<p>These hierarchical structures can be serialized and stored in different ways, typically they are stored as binary geoms and stored directly in a table.</p>
<p>An interesting aspect here is that these structures don’t describe the topology of the objects in any special way, these are just <em>paths</em> of coordinates, and when they are plotted or used in analysis there’s a rule about how space is enclosed by a closed path. If we treat them as lines, the only difference is to not treat them as enclosed paths. Literally the only difference in the structure of this object from the polygons version is the name of the class, and the behaviour that methods invoked for this object will provide.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(<span class="kw">as</span>(pnganz, <span class="st">"SpatialLinesDataFrame"</span>))
<span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(<span class="kw">as</span>(pnganz, <span class="st">"SpatialLinesDataFrame"</span>), <span class="dt">col =</span> viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">viridis</a></span>(<span class="kw">nrow</span>(pnganz), <span class="dt">alpha =</span> <span class="fl">0.7</span>), <span class="dt">lwd =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(<span class="kw">as</span>(<span class="kw">geometry</span>(pnganz[<span class="dv">1</span>,]), <span class="st">"SpatialLines"</span>))</code></pre></div>
<pre><code>## Formal class 'SpatialLines' [package "sp"] with 3 slots
##   ..@ lines      :List of 1
##   .. ..$ :Formal class 'Lines' [package "sp"] with 2 slots
##   .. .. .. ..@ Lines:List of 2
##   .. .. .. .. ..$ :Formal class 'Line' [package "sp"] with 1 slot
##   .. .. .. .. .. .. ..@ coords: num [1:17, 1:2] 145 146 147 148 148 ...
##   .. .. .. .. ..$ :Formal class 'Line' [package "sp"] with 1 slot
##   .. .. .. .. .. .. ..@ coords: num [1:224, 1:2] 144 144 145 145 145 ...
##   .. .. .. ..@ ID   : chr "9"
##   ..@ bbox       : num [1:2, 1:2] 113.3 -43.6 153.6 -10.7
##   .. ..- attr(*, "dimnames")=List of 2
##   .. .. ..$ : chr [1:2] "x" "y"
##   .. .. ..$ : chr [1:2] "min" "max"
##   ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
##   .. .. ..@ projargs: chr "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"</code></pre>
<p>If we convert these data to “normal form”, we actually need at least three tables, one each for the objects, the branches, and the coordinates (vertices). The <code>map_table</code> function in the <code>spbabel</code> package creates these but also adds another link table between branches and vertices to enable de-duplication of shared vertices. The de-duplication is required for triangulating the polygons, and other topological operations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs &lt;-<span class="st"> </span>spbabel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/spbabel/topics/map_table">map_table</a></span>(pnganz)
<span class="kw">print</span>(<span class="kw">names</span>(ptabs))</code></pre></div>
<pre><code>## [1] "o"   "b"   "bXv" "v"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">sapply</span>(ptabs, nrow))</code></pre></div>
<pre><code>##   o   b bXv   v 
##   4  21 638 614</code></pre>
<p>Now it’s a bit clearer how the underlying entities are put together. Each table here has a unique relational id, this allows us to subset and recombine these tables without having to convert indexes each time.</p>
<p>The objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs<span class="op">$</span>o</code></pre></div>
<pre><code>## # A tibble: 4 x 3
##               name     color    object_
## *           &lt;fctr&gt;     &lt;chr&gt;      &lt;chr&gt;
## 1        Australia #440154FF CU92FoIIVe
## 2        Indonesia #31688EFF iU8tl8bf93
## 3      New Zealand #35B779FF i0lRAzDfj5
## 4 Papua New Guinea #FDE725FF 01QCdfesoB</code></pre>
<p>The branches record which object they belong to.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs<span class="op">$</span>b</code></pre></div>
<pre><code>## # A tibble: 21 x 3
##       object_    branch_ island_
##         &lt;chr&gt;      &lt;chr&gt;   &lt;lgl&gt;
##  1 CU92FoIIVe luW7xnb9SL    TRUE
##  2 CU92FoIIVe VB4bkQg1oJ    TRUE
##  3 iU8tl8bf93 L82ZXCW3Hg    TRUE
##  4 iU8tl8bf93 Wyykld0Uha    TRUE
##  5 iU8tl8bf93 sRKBBCBF6h    TRUE
##  6 iU8tl8bf93 G9cQaZwu02    TRUE
##  7 iU8tl8bf93 uhcJYb27J0    TRUE
##  8 iU8tl8bf93 rxRd3a56DI    TRUE
##  9 iU8tl8bf93 hZ4lXxuQfp    TRUE
## 10 iU8tl8bf93 XqaY4Tv8gS    TRUE
## # ... with 11 more rows</code></pre>
<p>The branches-link-vertex table records the relationship between vertices and branches (by default the de-duplication is done in X-Y but it could be done in other geometric spaces, e.g. in 1D time or 3D X-Y-Z or X-Y-Time).</p>
<p>This is the <em>instances of vertices</em> as opposed to the unique paired values of coordinates themselves.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs<span class="op">$</span>bXv</code></pre></div>
<pre><code>## # A tibble: 638 x 3
##       branch_ order_    vertex_
##         &lt;chr&gt;  &lt;int&gt;      &lt;chr&gt;
##  1 luW7xnb9SL      1 QqLpqwKW9H
##  2 luW7xnb9SL      2 100n7GrKl0
##  3 luW7xnb9SL      3 hhybIJEzIY
##  4 luW7xnb9SL      4 6ijyhxtKZi
##  5 luW7xnb9SL      5 FtvtWBlEAH
##  6 luW7xnb9SL      6 RnzNuzcovi
##  7 luW7xnb9SL      7 nV4hqvBjw2
##  8 luW7xnb9SL      8 GoPa1bdLBo
##  9 luW7xnb9SL      9 lXhZhorjsn
## 10 luW7xnb9SL     10 SO7y5ifMDu
## # ... with 628 more rows</code></pre>
<p>And finally the vertices. In this example there are fewer unique x-y vertex than there are <strong>instance of the vertices</strong>, not a one-to-one match. This discrepancy obviously increases greatly for layers with shared boundaries, though in this example it is mostly due to the final closing coordinate on each polygon path - it’s a repeated instance, but not a repeated vertex <em>value</em>. There is at least one shared edge in this layer, clearly the one between Indonesia and Papua New Guinea.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ptabs<span class="op">$</span>v</code></pre></div>
<pre><code>## # A tibble: 614 x 3
##          x_        y_    vertex_
##       &lt;dbl&gt;     &lt;dbl&gt;      &lt;chr&gt;
##  1 145.3980 -40.79255 QqLpqwKW9H
##  2 146.3641 -41.13770 100n7GrKl0
##  3 146.9086 -41.00055 hhybIJEzIY
##  4 147.6893 -40.80826 6ijyhxtKZi
##  5 148.2891 -40.87544 FtvtWBlEAH
##  6 148.3599 -42.06245 RnzNuzcovi
##  7 148.0173 -42.40702 nV4hqvBjw2
##  8 147.9141 -43.21152 GoPa1bdLBo
##  9 147.5646 -42.93769 lXhZhorjsn
## 10 146.8703 -43.63460 SO7y5ifMDu
## # ... with 604 more rows</code></pre>
<div id="polygons-are-just-lines" class="section level2">
<h2 class="hasAnchor">
<a href="#polygons-are-just-lines" class="anchor"></a>Polygons are just lines</h2>
<p>From this form we can see clearly that polygons and lines in GIS are really the same thing, we have <em>paths of coordinates</em> and then rules about how they are used.</p>
<p>If we compare each entity table side by side it’s clear the only difference is whether a branch is badged as an island vs. a hole.</p>
<p>For points we don’t need the branches or the order data, though for multipoints we do need branch.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ltabs &lt;-<span class="st"> </span>spbabel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/spbabel/topics/map_table">map_table</a></span>(<span class="kw">as</span>(pnganz, <span class="st">"SpatialLinesDataFrame"</span>))

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(ltabs)) {
  <span class="kw">writeLines</span>(<span class="st">"------------------------------"</span>)
<span class="co">#  print(ltabs[i])</span>
  <span class="kw">print</span>(ptabs[i])
 <span class="kw">writeLines</span>(<span class="st">""</span>)
<span class="co">#  str(ltabs[[i]])</span>
<span class="co">#  str(ptabs[[i]])</span>
}</code></pre></div>
<pre><code>## ------------------------------
## $o
## # A tibble: 4 x 3
##               name     color    object_
## *           &lt;fctr&gt;     &lt;chr&gt;      &lt;chr&gt;
## 1        Australia #440154FF CU92FoIIVe
## 2        Indonesia #31688EFF iU8tl8bf93
## 3      New Zealand #35B779FF i0lRAzDfj5
## 4 Papua New Guinea #FDE725FF 01QCdfesoB
## 
## 
## ------------------------------
## $b
## # A tibble: 21 x 3
##       object_    branch_ island_
##         &lt;chr&gt;      &lt;chr&gt;   &lt;lgl&gt;
##  1 CU92FoIIVe luW7xnb9SL    TRUE
##  2 CU92FoIIVe VB4bkQg1oJ    TRUE
##  3 iU8tl8bf93 L82ZXCW3Hg    TRUE
##  4 iU8tl8bf93 Wyykld0Uha    TRUE
##  5 iU8tl8bf93 sRKBBCBF6h    TRUE
##  6 iU8tl8bf93 G9cQaZwu02    TRUE
##  7 iU8tl8bf93 uhcJYb27J0    TRUE
##  8 iU8tl8bf93 rxRd3a56DI    TRUE
##  9 iU8tl8bf93 hZ4lXxuQfp    TRUE
## 10 iU8tl8bf93 XqaY4Tv8gS    TRUE
## # ... with 11 more rows
## 
## 
## ------------------------------
## $bXv
## # A tibble: 638 x 3
##       branch_ order_    vertex_
##         &lt;chr&gt;  &lt;int&gt;      &lt;chr&gt;
##  1 luW7xnb9SL      1 QqLpqwKW9H
##  2 luW7xnb9SL      2 100n7GrKl0
##  3 luW7xnb9SL      3 hhybIJEzIY
##  4 luW7xnb9SL      4 6ijyhxtKZi
##  5 luW7xnb9SL      5 FtvtWBlEAH
##  6 luW7xnb9SL      6 RnzNuzcovi
##  7 luW7xnb9SL      7 nV4hqvBjw2
##  8 luW7xnb9SL      8 GoPa1bdLBo
##  9 luW7xnb9SL      9 lXhZhorjsn
## 10 luW7xnb9SL     10 SO7y5ifMDu
## # ... with 628 more rows
## 
## 
## ------------------------------
## $v
## # A tibble: 614 x 3
##          x_        y_    vertex_
##       &lt;dbl&gt;     &lt;dbl&gt;      &lt;chr&gt;
##  1 145.3980 -40.79255 QqLpqwKW9H
##  2 146.3641 -41.13770 100n7GrKl0
##  3 146.9086 -41.00055 hhybIJEzIY
##  4 147.6893 -40.80826 6ijyhxtKZi
##  5 148.2891 -40.87544 FtvtWBlEAH
##  6 148.3599 -42.06245 RnzNuzcovi
##  7 148.0173 -42.40702 nV4hqvBjw2
##  8 147.9141 -43.21152 GoPa1bdLBo
##  9 147.5646 -42.93769 lXhZhorjsn
## 10 146.8703 -43.63460 SO7y5ifMDu
## # ... with 604 more rows</code></pre>
</div>
<div id="what-makes-polygons-different-to-lines" class="section level2">
<h2 class="hasAnchor">
<a href="#what-makes-polygons-different-to-lines" class="anchor"></a>What makes polygons different to lines?</h2>
<p>The coordinate-path structures used above for polygons and lines are very explicit, and in traditional form cannot be used in a more abstract way. By collecting the attributes of the entities in use into their own tables we start to build this abstraction. The paths are represented as a sequence of identifiers, rather than the actual coordinate values themselves. Why do this? We can abstract the choice of what do with those coordinate away from their storage. We also get a limited form of topology, in that a change made to one vertex coordinate attribute is reflected in all of the branches that use that vertex, analogous the Shared Edit mode in Manifold 8.0.</p>
<p>The next step in topological relationships is to represent each <em>segment</em> of a line rather than the entire path. To do this we need a table of segments, and a link table to store the identity of the two vertices used by those segments.</p>
<p>This has been implemented in the package <code>anglr</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lsegment &lt;-<span class="st"> </span>anglr<span class="op">::</span><span class="kw">anglr</span>(<span class="kw">as</span>(pnganz, <span class="st">"SpatialLinesDataFrame"</span>))</code></pre></div>
<pre><code>## Warning in rgl.init(initValue, onlyNULL): RGL: unable to open X11 display</code></pre>
<pre><code>## Warning: 'rgl_init' failed, running with rgl.useNULL = TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.data.frame</span>(<span class="kw">lapply</span>(lsegment, nrow))</code></pre></div>
<pre><code>##   o   v   l  lXv meta
## 1 4 617 617 1234    1</code></pre>
<p>This is no different for polygons when we store them as polygon paths, so then why is the segment/edge model useful? It provides a table to store metrics such as the length of the segment, its duration in time, and other information. The segment/edge model is also a required precursor for building a triangulated mesh. This brings us to an important stage of the story.</p>
</div>
<div id="polygons-are-not-composed-of-primitives" class="section level2">
<h2 class="hasAnchor">
<a href="#polygons-are-not-composed-of-primitives" class="anchor"></a>Polygons are not composed of primitives</h2>
<p>Lines and polygons are stored as paths of coordinates, but lines can be decomposed to a more abstract form. Once in this form we can (in R) plot the lines much more quickly as segments, each with their own individual properties.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))
<span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(lsegment<span class="op">$</span>v<span class="op">$</span>x_, lsegment<span class="op">$</span>v<span class="op">$</span>y_, <span class="dt">asp =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="st">"."</span>, <span class="dt">axes =</span> <span class="ot">FALSE</span>)
<span class="kw">lines</span>(lsegment<span class="op">$</span>v<span class="op">$</span>x_, lsegment<span class="op">$</span>v<span class="op">$</span>y_, <span class="dt">col =</span> viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">viridis</a></span>(<span class="dv">4</span>))</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>Not surprisingly, our connected line doesn’t make much sense, but worse our attempts at applying multiple colours was completely unsuccessful. Segments to the rescue.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))
<span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(lsegment<span class="op">$</span>v<span class="op">$</span>x_, lsegment<span class="op">$</span>v<span class="op">$</span>y_, <span class="dt">asp =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="st">"."</span>, <span class="dt">axes =</span> <span class="ot">FALSE</span>)
lsegment<span class="op">$</span>o<span class="op">$</span>color &lt;-<span class="st"> </span>viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">viridis</a></span>(<span class="kw">nrow</span>(lsegment<span class="op">$</span>o))
<span class="co">#segs &lt;- lsegment$l %&gt;% inner_join(lsegment$o %&gt;% select(object_, color)) %&gt;% inner_join(lsegment$lXv) %&gt;% select(color, vertex_, segment_) %&gt;% inner_join(lsegment$v)</span>
segs &lt;-<span class="st"> </span>lsegment<span class="op">$</span>lXv <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(lsegment<span class="op">$</span>l) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(lsegment<span class="op">$</span>o <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(object_, color)) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(color, vertex_, segment_) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(lsegment<span class="op">$</span>v)</code></pre></div>
<pre><code>## Joining, by = "segment_"</code></pre>
<pre><code>## Joining, by = "object_"</code></pre>
<pre><code>## Joining, by = "vertex_"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ix &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(segs)<span class="op">-</span><span class="dv">1</span>, <span class="dt">by  =</span> <span class="dv">2</span>);  <span class="kw">segments</span>(segs<span class="op">$</span>x_[ix], segs<span class="op">$</span>y_[ix], segs<span class="op">$</span>x_[ix <span class="op">+</span><span class="st"> </span><span class="dv">1</span>], segs<span class="op">$</span>y_[ix<span class="op">+</span><span class="dv">1</span>], <span class="dt">col =</span> segs<span class="op">$</span>color[ix], <span class="dt">lwd =</span> <span class="dv">4</span>)</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p>This is not lovely code, though it is straight forward and systematic. Treated as segments we automatically get the right “topology” of our lines, we joined the object attribute down to the actual pairs of coordinates and plotted all the segments individually. We managed to keep our object-part-coordinate hierarchy, though we’ve chosen primitives belonging to objects rather than branches as the model. This is also convenient for the next step because line segments are what we need for generating primitives to represent the polygons as surfaces.</p>
</div>
<div id="constrained-polygon-triangulation-starts-with-line-primitives" class="section level2">
<h2 class="hasAnchor">
<a href="#constrained-polygon-triangulation-starts-with-line-primitives" class="anchor"></a>Constrained polygon triangulation starts with line primitives</h2>
<p>Treat the polygon as segments build a triangulation, a surface of 2D triangle primitives.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prim2D &lt;-<span class="st"> </span>anglr<span class="op">::</span><span class="kw">anglr</span>(pnganz)
<span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(pnganz, <span class="dt">border =</span> <span class="st">"black"</span>, <span class="dt">col =</span> <span class="st">"transparent"</span>, <span class="dt">lwd =</span> <span class="dv">4</span>)
<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq</span>(<span class="kw">nrow</span>(prim2D<span class="op">$</span>t))) {
  tri &lt;-<span class="st"> </span>prim2D<span class="op">$</span>t[i, ] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(prim2D<span class="op">$</span>tXv, <span class="st">"triangle_"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(prim2D<span class="op">$</span>v, <span class="st">"vertex_"</span>) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(x_, y_)
  <span class="kw">polygon</span>(tri<span class="op">$</span>x_, tri<span class="op">$</span>y_, <span class="dt">border =</span> (prim2D<span class="op">$</span>t[i, ] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(prim2D<span class="op">$</span>o, <span class="st">"object_"</span>))<span class="op">$</span>color[<span class="dv">1</span>])
}</code></pre></div>
<p><img src="spatial-normal-forms_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<p>The plot loop above is very inefficient, but it’s purely to illustrate that we have the shapes in the right form. This is used in anglr to plot the shapes in 3D, either in native planar form or as a surface of a globe.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgl)
<span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(prim2D, <span class="dt">specular =</span> <span class="st">"black"</span>)</code></pre></div>
<pre><code>## Joining, by = "object_"</code></pre>
<pre><code>## Joining, by = "triangle_"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subid &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rgl/topics/subscene3d">currentSubscene3d</a></span>()
<span class="kw"><a href="http://www.rdocumentation.org/packages/rgl/topics/rglwidget">rglwidget</a></span>(<span class="dt">elementId=</span><span class="st">"pnganz"</span>)</code></pre></div>
<div id="pnganz" style="width:672px;height:480px;" class="rglWebGL html-widget"></div>
<script type="application/json" data-for="pnganz">{"x":{"material":{"color":["#FFFFFF","#FF0000"],"alpha":1,"lit":true,"ambient":"#000000","specular":"#FFFFFF","emission":"#000000","shininess":50,"smooth":true,"front":"filled","back":"filled","size":3,"lwd":1,"fog":true,"point_antialias":false,"line_antialias":false,"texture":null,"textype":"rgb","texmipmap":false,"texminfilter":"linear","texmagfilter":"linear","texenvmap":false,"depth_mask":true,"depth_test":"less","isTransparent":false},"rootSubscene":1,"objects":{"6":{"id":6,"reuse":"rgl63190"},"5":{"id":5,"reuse":"rgl63190"},"4":{"id":4,"reuse":"rgl63190"},"1":{"id":1,"type":"subscene","par3d":{"antialias":1,"FOV":90,"ignoreExtent":false,"listeners":1,"mouseMode":{"left":"polar","right":"fov","middle":"zoom","wheel":"pull"},"observer":[0,0,69.4364776611328],"modelMatrix":[[1,0,0,-136.905059814453],[0,0.965925812721252,-0.258819043636322,19.8794364929199],[0,0.258819043636322,0.965925812721252,-64.1098022460938],[0,0,0,1]],"projMatrix":[[1,0,0,0],[0,1,0,0],[0,0,-1.41421365737915,-49.099006652832],[0,0,-1,0]],"skipRedraw":false,"userMatrix":[[1,0,0,0],[0,0.965925812721252,-0.258819043636322,0],[0,0.258819043636322,0.965925812721252,0],[0,0,0,1]],"scale":[1,1,1],"viewport":{"x":0,"y":0,"width":1,"height":1},"zoom":1,"bbox":[95.2930297851562,178.51708984375,-46.6412353515625,5.479820728302,0,0],"windowRect":[0,0,256,256],"family":"sans","font":1,"cex":1,"useFreeType":false,"fontname":"NULL","maxClipPlanes":2147483647,"glVersion":"NaN"},"embeddings":{"viewport":"replace","projection":"replace","model":"replace"},"objects":[4,6,5],"subscenes":[],"flags":1027}},"width":672,"height":480,"sphereVerts":{"reuse":"rgl63190"},"webGLoptions":{"preserveDrawingBuffer":true}},"evals":[],"jsHooks":[]}</script><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot-anglr.html">plot</a></span>(anglr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/anglr/topics/globe">globe</a></span>(prim2D), <span class="dt">specular =</span> <span class="st">"black"</span>)</code></pre></div>
<pre><code>## Joining, by = "object_"</code></pre>
<pre><code>## Joining, by = "triangle_"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subid &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rgl/topics/subscene3d">currentSubscene3d</a></span>()
<span class="kw"><a href="http://www.rdocumentation.org/packages/rgl/topics/rglwidget">rglwidget</a></span>(<span class="dt">elementId=</span><span class="st">"png_anz_globe"</span>)</code></pre></div>
<div id="png_anz_globe" style="width:672px;height:480px;" class="rglWebGL html-widget"></div>
<script type="application/json" data-for="png_anz_globe">{"x":{"material":{"color":["#FFFFFF","#FF0000"],"alpha":1,"lit":true,"ambient":"#000000","specular":"#FFFFFF","emission":"#000000","shininess":50,"smooth":true,"front":"filled","back":"filled","size":3,"lwd":1,"fog":true,"point_antialias":false,"line_antialias":false,"texture":null,"textype":"rgb","texmipmap":false,"texminfilter":"linear","texmagfilter":"linear","texenvmap":false,"depth_mask":true,"depth_test":"less","isTransparent":false},"rootSubscene":1,"objects":{"6":{"id":6,"reuse":"rgl63190"},"7":{"id":7,"reuse":"rgl84247"},"5":{"id":5,"reuse":"rgl63190"},"4":{"id":4,"reuse":"rgl63190"},"1":{"id":1,"type":"subscene","par3d":{"antialias":1,"FOV":90,"ignoreExtent":false,"listeners":1,"mouseMode":{"left":"polar","right":"fov","middle":"zoom","wheel":"pull"},"observer":[0,0,7098996],"modelMatrix":[[1,0,0,2894885.75],[0,0.965925812721252,-0.258819043636322,-3574210.5],[0,0.258819043636322,0.965925812721252,-5981258],[0,0,0,1]],"projMatrix":[[1,0,0,0],[0,1,0,0],[0,0,-1.41421365737915,-5019749],[0,0,-1,0]],"skipRedraw":false,"userMatrix":[[1,0,0,0],[0,0.965925812721252,-0.258819043636322,0],[0,0.258819043636322,0.965925812721252,0],[0,0,0,1]],"scale":[1,1,1],"viewport":{"x":0,"y":0,"width":1,"height":1},"zoom":1,"bbox":[-5789950,178.51708984375,-46.6412353515625,6326307,-4614473.5,605022.375],"windowRect":[0,0,256,256],"family":"sans","font":1,"cex":1,"useFreeType":false,"fontname":"NULL","maxClipPlanes":2147483647,"glVersion":"NaN"},"embeddings":{"viewport":"replace","projection":"replace","model":"replace"},"objects":[4,6,7,5],"subscenes":[],"flags":1027}},"width":672,"height":480,"sphereVerts":{"reuse":"rgl63190"},"webGLoptions":{"preserveDrawingBuffer":true}},"evals":[],"jsHooks":[]}</script><p>Why do this? It’s not just to plot a globe, but to see why it’s helpful to see what the function <code><a href="../reference/globe.html">globe()</a></code> does.</p>
<p>Run the layer through <code><a href="../reference/globe.html">globe()</a></code> and print out the vertices table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prim2D<span class="op">$</span>v</code></pre></div>
<pre><code>## # A tibble: 614 x 3
##          x_        y_    vertex_
##       &lt;dbl&gt;     &lt;dbl&gt;      &lt;chr&gt;
##  1 114.6165 -28.51640 YK4JKhzK8H
##  2 114.6420 -28.81023 9ykDihwoOJ
##  3 115.0400 -29.46110 zMM3d5lPQH
##  4 114.2329 -26.29845 HtDtmVBT4n
##  5 113.7784 -26.54903 QFfdiGdy6v
##  6 114.0489 -27.33477 v8VinH4DCE
##  7 114.1736 -28.11808 V1fm56kLiG
##  8 113.4775 -26.54313 YjF7ry9beh
##  9 115.0268 -34.19652 opq2S4KAZn
## 10 115.5451 -33.48726 RuVSF0LMck
## # ... with 604 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">anglr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/anglr/topics/globe">globe</a></span>(prim2D)<span class="op">$</span>v</code></pre></div>
<pre><code>## # A tibble: 614 x 4
##          x_      y_    vertex_       z_
##       &lt;dbl&gt;   &lt;dbl&gt;      &lt;chr&gt;    &lt;dbl&gt;
##  1 -2336231 5098892 YK4JKhzK8H -3026914
##  2 -2331985 5083655 9ykDihwoOJ -3055489
##  3 -2352381 5035508 zMM3d5lPQH -3118501
##  4 -2348469 5217578 HtDtmVBT4n -2808743
##  5 -2302026 5224737 QFfdiGdy6v -2833605
##  6 -2310595 5177787 v8VinH4DCE -2911217
##  7 -2305320 5135903 V1fm56kLiG -2988053
##  8 -2274676 5237020 YjF7ry9beh -2833021
##  9 -2234102 4785201 opq2S4KAZn -3564497
## 10 -2296191 4804324 RuVSF0LMck -3499156
## # ... with 604 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#subid &lt;- currentSubscene3d()</span>
<span class="co">#rglwidget(elementId="prim2D")</span></code></pre></div>
<p>The only thing that happened was that the input <code>x_</code> and <code>y_</code> were converted to geocentric “x, y, z” coordinates. Under the hood this is done by driving the transformation with PROJ.4 (via the R package <code>proj4</code>). The PROJ.4 family in use is “geocent”, i.e. here the <code>meta</code> table simply records the history of transformations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">anglr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/anglr/topics/globe">globe</a></span>(prim2D)<span class="op">$</span>meta[, <span class="kw">c</span>(<span class="st">"proj"</span>, <span class="st">"ctime"</span>)]</code></pre></div>
<pre><code>## # A tibble: 2 x 2
##                                                              proj
##                                                             &lt;chr&gt;
## 1                                      +proj=geocent +ellps=WGS84
## 2 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0
## # ... with 1 more variables: ctime &lt;chr&gt;</code></pre>
<p>We can otherwise do anything we like with the vertices, including reprojecting them and copying on other attributes.</p>
<p>As an example, copy on the Etopo5 elevations, first with the default triangulation, and then with a denser version.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## <span class="al">TBD</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#spatial-normal-forms">Spatial normal forms</a><ul class="nav nav-pills nav-stacked">
<li><a href="#polygons-are-just-lines">Polygons are just lines</a></li>
      <li><a href="#what-makes-polygons-different-to-lines">What makes polygons different to lines?</a></li>
      <li><a href="#polygons-are-not-composed-of-primitives">Polygons are not composed of primitives</a></li>
      <li><a href="#constrained-polygon-triangulation-starts-with-line-primitives">Constrained polygon triangulation starts with line primitives</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michael D. Sumner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
